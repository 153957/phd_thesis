\chapter{\hisparc network}
\label{ch:cluster}

The data from multiple \hisparc stations can be combined to perform data analysis with more detection points separated by larger distances. In order to combine the data the exact detection time of individually (per station) detected showers must be known. The \gps module of each station is used to acquire accurate absolute timestamps. The accuracy of the \gps is examined to determine the error it introduces when cominbing data from multiple stations. Not only the timing error, but also the position error is examined.


\section{Positions}

Before a \gps reciever can accurately determine the current time it needs to know where it is. Since the \gps antenna is stationary, its location can be determined very accurately once and then kept fixed. The \gps then only needs to worry about the time. Since it knows its position and the orbits of each \gps satellite it could determine the current time with the signal of only one \gps satellite. However, when more are used a more accurate result is achieved.


\subsection{\gps self-survey}

To get a fix on the position of a stationary \gps antenna the \gps can perform a self-survey. During the self-survey the \gps will continuously determine its location, at the end of the survey the center of the clouds of positions will be taken as the correct location. \gps satellites orbit the Earth every \SI{12}{\hour}, taking in account the rotation of the Earth each \gps satellite will be above the same location of the Earth every \SI{24}{\hour}. By using a self-survey of \SI{86400}{\second} (i.e. \SI{24}{\hour}) a good average is determined, which should minimize the position error. This self-survey needs to be performed only once, if the \gps antenna remains fixed in its place.

The accuracy of the position after a self-survey is horizontally better than \SI{0.5}{\meter}, the altitude is slightly less accurate, but still within \SI{1}{\meter}. Two \gps antennae separated by \SI{2}{\meter} are used by station 501 and station 510. Each station performed a self-survey with its own \gps and one with the \gps of the other station to test the accuracy. Horizontal position differences of \SI{1.}{\centi\meter} were measured using the same \gps antennae. However, altitude differences of \SI{2}{\meter} were seen. The size of the errors is partially due to the high latitude (\SI{>50}{\degree}) of the Netherlands. \gps satellite orbits have an inclination of \SI{55}{\degree}. Rarely will a satellite be see straight overhead or towards North in the Netherlands. Most of observed satellites will be on the Southern part of the sky. For locations above \SI{55}{\degree} satellites will only be seen towards the Southern sky. Normally elevation masks are used to exclude \gps satellites close to the horizon. This is done because signals from those satellites pass through a larger amount atmosphere, increasing the chances of distortions. However, for locations at high latitudes they need to be included to increase the accuracy.

%\begin{verbatim}
%GPS s510
%s510  1412347130	52.3558955	4.9509864	54.59
%s501  1414406502	52.3558990	4.9509880	57.65
%
%GPS s501
%s501  1412347557	52.3558800	4.9510065	55.40
%s510  1414406952	52.3558859	4.9510083	57.39
%\end{verbatim}


\section{Timing}

When a \hisparc station is first deployed the \gps will determine its location for \SI{24}{\hour}. After this the \gps will enter the so called `Overdetermined Clock' mode. In this mode the \gps keeps it position fixed and only concerns itself with timing. This should result in an absolute timing accuracy of \SI{5}{\ns}.


\subsection{Making event timestamps}
\label{sub:gps_timestamps}

% Explain what goes into creating an extended timestamp, from trigger and PPS to ext_timestamp.
Every second the \gps receiver sends a Pulse Per Second (\pps) signal to the \hisparc electronics to indicate the start of a second \cite{verkooijen2008firmware}. The \hisparc box uses a \SI{200}{\mega\hertz} clock to determine the time within this second. The clock is synchronized to the \pps. However, crystal in this internal clock does not work at exactly \SI{200}{\mega\hertz}. To correctly determine the time within a second a clock tick counter is read at the moment of a trigger (\ctd) and when each \pps arrives (\ctp). The counter is reset at each \pps. With these counts the fraction of the second at which the trigger occurred can be determined. For increased accuracy the two \adcs are used, one of which reads the signal on the negative side of the clock pulse. If the `negative' \adc caused a trigger the final timestamp will be offset by \SI{2.5}{\ns}. Effectively making it a \SI{400}{\mega\hertz} clock with \SI{2.5}{\ns} sampling.

% What are the errors on determining the ext_timestamp and how are some corrected for/minimized.
However, the fraction between \ctd and \ctp is not yet very accurate relative to the absolute \gps time. The \pps signals have slight time errors relative to the actual \gps seconds, caused by how the \pps is produced. The \gps module has an internal high-precision clock with a frequency of  \SI{12.504}{\mega\hertz}. The \pps is synchronized to the closest tick of this clock, of which both the positive and negative sides are used. This introduces an error of up to \SI{\pm 20}{\ns}. The size of this error is reported by the \gps module to the electronics after the \pps. This error is present at the start of each second and therefore both the error at start ($E_{\mathrm{Quan1}}$) and end ($E_{\mathrm{Quan1}}$) of each second need to be corrected. The total time between two \pps (i.e. the \ctp) is then $10^9 - E_{\mathrm{Quan1}} + E_{\mathrm{Quan2}} \si{\ns}$. Finally a synchronization error between the \pps and the \hisparc clock exists, the \SI{200}{\mega\hertz} clock is synchronized to the \pps. A synchonization error bit ($E_{\mathrm{Sync}}$) indicates if the time is shifted by \SI{2.5}{\ns} because the \pps arrived on the negative edge of the \SI{200}{\mega\hertz} clock.
Determination of the subsecond part of the timestamp is then done with the following equation
%
\begin{equation}
\label{eq:timestamp}
    \mathrm{Timestamp} =
        E_{\mathrm{Sync}} + E_{\mathrm{Quan1}} + \left(\frac{\ctd}{\ctp}\right)
        \left(10^9 - E_{\mathrm{Quan1}} + E_{\mathrm{Quan2}}\right) \ .
\end{equation}

Events are sent from the \hisparc electronics to the PC as soon as they are readout, because of the limited buffer space in the electronics. The events contain the trace data, timestamp (in seconds) of the `current second', and the \ctd. The events do not contain the \ctp of the second in which they occured. These are send separately in one second messages (\osm). The \osm is send at the start of each second. It contains the timestamp and synchronization error of the second, and the \ctp and quantization error of the previous second. The subsecond part of the timestamps is therefore determined on the PC where the data from the event and multiple \osm can be combined. The \osm for the start of the second of the event is required for the synchronization error. The \osm for the second after the event is required for the \ctp value and the first quantization error. The \osm for the next second is required required for the second quantization error. Note the Resolution T GPS Embedded Board User Guide incorrectly states the quantization error value is in seconds, it is in fact in nanoseconds.

% How it works for master/slave
The same procedure is performed for event from the Master and Slave electronics, each sends their own \osm and event messages to the PC. The Master passes the \pps is receives from the \gps on to the Slave electronics. This synchronizes their clocks, but also introduces another synchronization error. The timestamps determined for the Master and Slave event are used to find which events belong together. After this they are simply combined, discarding the timing information from the Slave events. Due to the clock synchronization errors between the Master and Slave errors of \SI{2.5}{\ns} between them needs to be expected. This explains the time differences reported in \cref{sec:masterslavetiming}.


\subsection{\gps timing accuracy}
\label{sec:gps_accuracy}

% Why we started \gps offset tests
Time difference calibration measurements have been performed on \hisparc II and III electronic boxes. This started after an unexpected time offset between the timestamps were observed in a test where two \hisparc stations (501 and 502) were triggered with the same pulse generator \cite[p. 47]{fokkema2012hisparc}. Since these stations are very close ($\sim\SI{100}{\meter}$) a distribution with minimal time differences were expected. However, a relatively large offset ($\Delta t \sim\SI{18}{\ns}$) was found, the width of the distribution (\SI{3}{\ns}) was within the expected \gps accuracy. Further tests have been performed to determine the cause of the offset, these tests are described in this section. Both the \hisparc electronics and \gps antennas were found to have varying offsets contributing to time differences in the resulting timestamps.


\subsection{Test setup}
\label{sub:gps_test_setup}

In the setup one \hisparc II Master (hardware serial: 62) is used as the main reference point for the entire test. All other \hisparc boxes were tested against this reference one at a time to measure the offset. Two \gps antennae separated by \SI{18}{\meter} and a \gps splitter were used. With the splitter was possible to perform tests in which both \hisparc electronics used the same \gps antenna, removing the offset caused by using different \gps antennas. A \SI{100}{\mega\hertz} Pulse Generator (as reference: tabor2005pulsegenerator), with two short equal-length signal cables and a signal splitter was used to trigger the \hisparc electronics. Each box was connected to the same pulse generator through either of the signal input channels. The electronics were set to trigger on a single high signal. In \cref{fig:setup} the setup is schematically shown.

\begin{figure}
    \centering
    \input{plots/cluster/gps_test_setup}
    \caption{This image shows the setup of the test. Two station PCs are used to control the \hisparc Master electronics (Reference and Test). The electronics are triggered simultaneously by same pulse generator. Each is also connected to a \gps, some tests used separate \gps antennas (a) and in some tests the same \gps was used by both (b).}
    \label{fig:setup}
\end{figure}


\subsection{\gps time offsets between \hisparc electronics}
\label{sub:gps_offsets}

% Summary of the tests
Approximately 10 tests were performed with each station using a separate \gps and 22 tests with stations using the \gps splitter. Each tests was with a different \hisparc electronics unit for the Test station. Additional tests with different configurations were performed, e.g. Master-Slave combinations, using the external trigger, or using intentionally offset \gps positions.

% Summary of results from normal tests
In the tests with separate \gps antennae the average offset was around \SI{25}{\ns}. Swapping the \gps antennae between the two electronics resulted in an offset shift of \SI{16}{\ns}. When using the splitter the average offset was only \SI{1.8}{\ns}. The results of these tests is shown in \cref{fig:hisparc_offsets}. This indicates that the different \gps antennae and cables are a large source of offsets. However, the different \hisparc electronics also contribute a bit to the offset. Also the average width of the time difference distributions of each test decreased from \SI{4.7}{\ns} to \SI{3.2}{\ns} [check these values]. The achieved timing accuracies are within the specification, except for the offsets, but those can be calibrated away.

\begin{figure}
    \centering
    \includegraphics{plots/cluster/hisparc_offsets}
    \caption{Time offsets relative to a reference box. Circles are the
             mean offsets, the error bars the standard deviation and the
             points indicate the minimum and maximum of the test.}
    \label{fig:hisparc_offsets}
\end{figure}


\subsubsection{Effects of alternative triggering}

% Effect of using a Slave
% Effect of using the external trigger.
When a Slave unit was attached to the electronics of the Test station and used for the input signal the offset was either equal or shifted by \SI{2.5}{\ns}. In several tests the input was switched from the regular \pmt inputs to the external trigger. This caused the time offset to change by \SI{123.3}{\ns}. This change is likely due to internal differences in the electronics and firmware. However, since the external trigger is normally not used this offset is not very important.

\subsubsection{Bad position leads to inaccurate timing}

In several tests a bad position was entered in the \gps module, claiming the \gps antenna was placed \SI{>25}{\meter} away from where it actually was. The timing accuracy clearly degraded. Moreover, the time differences over time showed periodicity, this is shown in \cref{fig:tt_delta_time_022}. The width of the time difference distribution increased to \SI{12}{\ns}. Note that if a \gps module is given a position more than \SI{250}{\meter} from its actual position it will automatically start a self-survey to acquire a better position.

\begin{figure}
    \centering
    \includegraphics{plots/cluster/tt_delta_time_022}
    \caption{Time difference measurements for a test where a \gps was giving wrong position information, in this case offset by \SI{25}{\meter}. The errors in the time offset vary during the day but clearly follow a \SI{24}{\hour} period, i.e. the time it takes for \gps configurations on the sky to repeat.}
    \label{fig:tt_delta_time_022}
\end{figure}


\section{Data taking}

% How the network started, when stations were built.
In 2004 \hisparc started data collection. Initially with several stations in Amsterdam, later expanding to other regions. Over the last \SI{12}{\year} the number of stations with data has grown at an average rate of one per month.


\subsection{Station locations}

% Current station locations, explain why the stations are in those locations. Due to those being the locations of high schools..
In \cref{fig:network} the locations of all \hisparc stations is shown. Most stations are clustered in or around the slightly larger cities. The locations are in most cases limited to the locations of high schools and universities. Universities provide support for the high schools in their region, they guide students in building the detectors and provide assistance when needed. There are currently about \num{650} high schools in the Netherlands  \cite{duo2016hoofd}, some of which have multiple locations, resulting in a total of about \num{1500} high-school locations \cite{duo2016all}. Currently there are \num{80} [get actual number] Dutch high schools participating in \hisparc.


\subsubsection{International}

Locations of \hisparc stations are not limited to the Netherlands. Two other countries also successfully operate multiple detection stations.

Since 2007 there has been a \hisparc station in Denmark. There are currently 3 operational stations at the Aarhus University. These stations are managed by Uffe Amelung Fredens. Fredens also makes student materials for Danish high-school students.

In the United Kingdom a new cluster in Bristol was started in March 2012. This was initiated by Dr. Jaap Velthuis, who is the cluster coordinator for the Bristol cluster. Since then more than 10 schools around Bristol have created detectors and joined the network. Even more schools have plans to join. In 2014 a second cluster was started in the United Kingdom around Birmingham. The Birmingham cluster is coordinated by Cristina Lazzeroni.

In Germany a station (70001) was placed inside the \kascade experiment in Karlsruhe, it operated there from 2008 up to and including 2011. This was done to calibrate and test the direction reconstruction accuracy of a single \hisparc station. Although the \kascade-GRANDE experiment officially shut down on March 30, 2009, it was kept active until November, 26th 2011 as a test facility for other experiments, including the \hisparc detection station. When the \kascade detectors detected a shower the \hisparc station was triggered. More than \num{9e7} triggers occurred [2010-2011 in datastore, rest in /databases/kascade] in this period. The detectors used for the \kascade station have since been repurposed and now form station 508 at the Science Park.

\begin{figure}
    \centering
    \includegraphics[width=0.6\textwidth]
                    {plots/cluster/network}
    \caption{Locations of \hisparc stations in Netherlands, United Kingdom, and Denmark. Stations which also include a weather station are indicated with red circles.}
    \label{fig:network}
\end{figure}


\subsection{Uptime}

Unfortunately not all stations continue to operate properly. \cref{fig:active_stations} shows the cumulative number of stations that have had at least a days worth of events (green), additionally the number of active stations per day (black) is also shown. Though the number of active station also increases it lags behind the total number of stations. This is partially explained by stations being moved to a new location under a new name. In which case both stations count toward the total number of stations, but only one active station. In some cases the contact person at a high station retired without arranging followup, leaving the station without proper maintenance. Other problems that have been known to cause stations to be down are Windows Updates, internet connectivity, bad configuration, power supply failures, light leaks in the detectors, or some other issues [cite maintenance docs]. In many cases (software or configuration related problems) remote control of the station can be used to make station operational again.

\begin{figure}
    \centering
    \includegraphics[width=0.6\textwidth]
                    {plots/cluster/active_stations}
    \caption{Cumulative number of stations with at least an hour of good data and the number of active stations per day.}
    \label{fig:active_stations}
\end{figure}


% Each station submits data/triggered events to central datastore
When a station records data is uploads it to the central datastore at \nikhef. Here further offline analysis is performed and the data is made available for download. The automatic data analysis that is performed is described in [a later chapter]. The data is sent from the station as a HTTP POST request to the datastore server. This server checks the station number and password for verification and also if all data is correctly recieved using a checksum. If this succeeds the data is stored in the raw datastore. The datastore stores the detected events, comparator data, configuration settings, error messages, single rates, and \gps signal information. Additionally a station may upload weather data, for which the data, configuration and errors are stored. In \cref{fig:luminosity_network} the cumulative number of detected events (green) and verified good events (black) are shown.

\begin{figure}
    \centering
    \includegraphics[width=0.6\textwidth]
                    {plots/cluster/luminosity_network}
    \caption{Cumulative number of events by all stations, the lower line contains only events when the stations were working properly.}
    \label{fig:luminosity_network}
\end{figure}

% Use offline analysis to find station events detecting the same shower.
  % - This requires good absolute timing at the stations.
  % - Use GPS at stations for both positioning of the stations (\SI{~1}{\meter}) and absolute timing (\SI{~5}{\ns}).
An `offline trigger' is used to determine when stations were probably detecting the same shower. This is similar to the station trigger. In this case the data is searched for (at least two) stations that simultaneously (i.e. within a certain time window) detected events. These events that are likely due to the same shower are called coincidences. Coincidences between stations are expect to be caused by either the detection of the same shower, the detection of separate but correlated showers (due to the GZ-effect), or the detection of two unrelated showers.

The absolute timing of events detected by stations is important when looking for coincidences. It also influences the resolution with which coincidences can be reconstructed, because the arrival times in the detectors of the stations is to be compared.

Important for shower reconstruction, coincidence rate, and possibilities for detection the GZ-effect are the distances between pairs of stations. In \cref{fig:network_station_distances} the distribution of distances between all possible pairs of stations are shown. The points beyond \SI{250}{\kilo\meter} are due to combinations between stations in different countries. And the pair separated by only \SI{2}{\meter} is the combination of station 501 and 510. These were intentionally interlaced to compare the results from two stations which are virtually at the same location. The results from comparing these stations is shown in [ref to later chapter about station performance or reconstructions].

\begin{figure}
    \centering
    \includegraphics[width=0.6\textwidth]
                    {plots/cluster/network_station_distances}
    \caption{Distribution of distances between all possible pairs of stations in the entire \hisparc network.}
    \label{fig:network_station_distances}
\end{figure}


\subsection{Coincidence rate}

% Stations closer than \SI{2e3}{\meter} are likely to at some point detect the same shower.
Station pairs separated by up to \SI{2e3}{\meter} are likely to detect the same shower at some point in time. At distances of \SI{2e3}{\meter} the rate of coincidences is so low that it approaches the rate of random coincidences due to random background particles. Real events may still be distinguishable from background if the event can be reconstructed very well. Large showers which can be detected efficiently by two stations both \SI{e3}{\meter} from the shower core have energies of at least \SI{e18}{\eV}. Such showers are rare, from \cref{fig:spectrum} we can estimate a rate of approximately \SI{1}{\per\kilo\meter\squared\per\day}. The sensitivity to those showers is not equal over that \si{\kilo\meter\squared} area, so a lower rate is expected.

% estimate the coincidence rate for showers of certain energy.
As the distance between stations increase the probability of detecting low energy showers decrease. The highest contributions to coincidences are the lowest energy showers that can still be detected efficiently. This smoothly transitions to continually higher showers being the dominant source for coincidences. A rough estimate can be made by using the methods described above. For detector stations at a given distance calculate the probability of detecting showers for all relevant energies in the cosmic-ray spectrum (\SIrange{e13}{e20}{\eV}). Assume that the shower hit precisely between the stations, where the probability is highest. Scale the determined probability of detection with the occurrence of such showers and compensate for the larger effective area for which high energy showers will be detectable.

In \cref{fig:distance_v_coincidence_rate} the coincidence rate is determined for all pairs of stations. Counting only the time that both stations were working properly. The determined coincidence rate is then plotted against the distance between the stations. Different coincidence rates due to detection efficiencies caused by the different number of detectors in stations is expected. The different combinations of two 2-detector, two 4-detector, and a 2- and 4-detector stations are indicated by different symbols. The background rate is estimated by \cref{eq:background_rate} and indicated by the horizontal dashed lines. A set of station pairs to far apart (\SI{>9}{\kilo\meter}) to expect coincidences is also shown to verify the background rates.

\begin{figure}
    \centering
    \includegraphics[width=0.6\textwidth]
                    {plots/cluster/distance_v_coincidence_rate}
    \caption{Coincidence rate between stations as a function of distance. At increasing distances the contributions from increasingly larger/energetic showers dominate. The background rate is also shown (dashed). Real events may still be distinguished from background. The square indicates two 4-detector stations, triangle for a 4- and 2-detector station, and the circle two 2-detector stations.}
    \label{fig:distance_v_coincidence_rate}
\end{figure}


\subsection{Compensating for station timing offsets}

The offsets were found to be stable over time and varying for different combinations of \hisparc electronics and \gps antennae. In some cases the offset was larger than \SI{30}{\ns}, which can have a significant effect on the direction reconstruction of showers, depending on the distance to other stations.

The offset can be determined from real data. For any combination of two stations the ideally expected mean time difference of all coincident events is, because of mirror symmetry, \SI{0}{\ns}. However, the width of the distribution is very dependent on the distance between the stations, because inclined showers will create larger time differences if the stations are further apart, and a large core distances the effect of shower front curvature and rise time become mor relevant. Moreover, the increased distance means that less events will be detected by both stations simultaneously because showers of higher energy and larger footprints occur less often. To determine the offset between stations that are further apart more data is required, and a longer time is required to get that data. However, at some point the time offsets are no longer very important because the effect on the shower reconstruction will be negligible relative to the large distance.


\subsection{Station timing offsets}

The \hisparc stations at the Science Park are relatively close.. bla bla.


In \cref{fig:station_offsets_501_502}
\begin{figure}
    \centering
    \input{plots/response/station_offsets_501_502}
    \caption{\captitle{Coincidence time difference distribution.} The
             time difference between events in coincidence detected by
             station 501 and 502 in a three week period in 2010. The
             width of the distribution is caused by the distance between
             stations and showers under angles.}
    \label{fig:station_offsets_501_502}
\end{figure}

\begin{figure}
    \centering
    \input{plots/response/station_offsets_501_510}
    \caption{\captitle{Coincidence time difference distribution.} The
             time difference between events in coincidence detected by
             station 501 and 510 in a three week period in 2014. The
             width of the distribution here is caused by \gps accuracy.
             The reason for two distributions is that at some point in
             the period the \gps antennas were switched between the two
             stations.}
    \label{fig:station_offsets_501_510}
\end{figure}

