\chapter{Software}
\label{ch:software}

\section{Structure}


\section{\github}

Our code has transitioned from bazaar to \git, a different distributed
version control system. This made it possible to use the service \github
to host our projects. \github provides a web-interface to manage
projects, keep track of issues, and manage pull requests.

When we were using Bazaar our repositories were hosted on a Nikhef
server, this made it difficult for others to participate and contribute.
On \github the software has been open sourced and can be downloaded with
a single click, on any system.

\github also provides webpage hosting of static pages for repositories,
called \github Pages. We use it to host software documentation and
compiled version of the teaching materials, for which the sources are
also on \github.


\section{Repositories}

This is a list of the different repositories.

\begin{verbatim}
Data analysis/presentation
sapphire - SAPPHiRE, a framework for HiSPARC
pysparc - HiSPARC DAQ implemented in Python
publicdb - The HiSPARC Public Database
jsparc - Javascript library and coincidences analysis
topaz PRIVATE - Scripts for small analyses with HiSPARC data
tijdtest PRIVATE - Analysis for the time calibration of HiSPARC boxes

Detection
datastore - Data storage solution
station-software - Software running on HiSPARC station pc's
hisparcdaq - DAQ software
weather - Weather DAQ software
lightning - Lightning DAQ software
firmware - FPGA source

Teaching Material
infopakket - Teaching materials
routenet - High-school course material

Papers
experiment PRIVATE - Paper about the HiSPARC experimental setup
2014_direction PRIVATE - Paper about HiSPARC direction reconstruction chain

Webpages
hisparc.github.io - HiSPARC GitHub Pages
logo - HiSPARC logo's
servers - Contains details on how the HiSPARC servers are setup
maintenance - HiSPARC station maintenance information
Some code repositories have their documentation in a gh-pages branch
\end{verbatim}

Add some flowcharts


\section{\hisparc Public Database}

\subsection{\api}

To make interactive applications (see \jsparc) we needed to make
access to all kinds of data easy. To facilitate this an \api has been
added to the Public Database. The \api consists of a number of urls that
return data in the form of a JSON (Javscript Object Notation). For
example a list of \hisparc stations can be retrieved via
\url{http://data.hisparc.nl/api/stations/}, the result is:

\begin{minted}{json}
[
    {"name": "St. Nicolaaslyceum",
     "number": 2},
    {"name": "Het Amsterdams Lyceum",
     "number": 3},
    {"name": "Chr. Sch. Gem. Buitenveldert",
     "number": 5},
    {"name": "Bern. Nieuwetijt Coll. (Damstede)",
     "number": 6},
    {"name": "Joke Smit College (ROC)",
     "number": 7},
    ...
    {"name": "Karlsruher Institut f√ºr Technologie",
     "number": 70001}
]
\end{minted}

A list of all possible urls can be found at \url{http://data.hisparc.nl/api/}.

Functions have been added to both \sapphire and \jsparc to access the
\api. These take care of constructing the urls and converting the json to a
sensible format for the programming language language.


\subsection{Event Summary Database}

Derived database with certain analyses applied, as explained later. Also
coincidences already found, next; automated reconstructions


\section{\sapphire}

\subsection{\pypi}

\sapphire is available via the Python Package Index (\pypi). This allows
package managers such as pip to easily find it, pip will also install
other packages which are required for \sapphire. However, some of these
packages require other (non-Python) libraries, such as hdf5, to be
installed, which pip will not do. It might be easier to install the
requirements before installing \sapphire itself. \sapphire can be
installed using this command:

\begin{verbatim}
$ pip install hisparc-sapphire
\end{verbatim}


\subsection{Clusters}

Using the \api \sapphire has access to the \gps coordinates of all
stations. For stations that have submitted their detector positions,
those are available as well. This makes it easy to setup a cluster with
any selection of \hisparc stations. This can be used for simulations.
Imaginary stations can be added to plan future station locations.


\subsection{\corsika}

Reading \corsika output, convert to \hdf and use for simulations.


\subsection{Simulations}

The simulations accept input from \corsika ground particle data, LDFs
(density), or shower front models (timing). Detector and station simulations based on experiments and models provide realistic output data. The data can
be analysed the same way as real \hisparc data (except that the input is
also known).

\begin{figure}
    \centering
    \input{plots/software/sapphire-flow}
    \caption{\captitle{\sapphire data chain.} The flow from
             creating/detecting data to reconstructed data.}
    \label{fig:sapphire-flow}
\end{figure}


\subsection{Data quality}

This code flags bad data and ensures that the data going into the
reconstruction is good data.

\todo{Write code to determine data quality.}


\section{Code testing}

Tests have been written to ensure that programming code does what is
expected, even when it is modified later. Code tests can be very
specific and precisely check the output given some inputs, check how
often another function is called, and ensure that the correct errors are
thrown when given invalid input. More general tests are also used to
validate code validity and coding style. A lot of effort has been put
into ensuring that all \python code adheres to the same coding style,
the Python Enhancement Proposal (PEP) 8 - Style Guide for Python Code.
Using a consistent style makes code easier to read and makes it easier
to see bugs. Moreover, the code can now be easily accessed by anyone via
\github.

These tests can be run locally while developing code. However,
developers might forget to run tests or do not want to spend time
testing. To ensure that new code is always tested the \sapphire and
\jsparc repositories have the \travis service \cite{travis} added. After
new commits are pushed to those repository \travis starts a Virtual
Machine that will download the repository and any requirements we have
defined and run the tests. The results are then displayed on the
repository page, and the person that pushed the code will get an e-mail
if the tests fail.

Having a test for a function does not guarantee that every bit of code
is tested. To check which parts of the code are tested we use a code
coverage tool. While \travis runs tests it keeps track of which lines of
code in \sapphire are run. At the end of the tests a report is sent to
\coveralls \cite{coveralls} which then shows overviews of which lines
have been tested and which have not. A common scenario is that only one
part of an if-else clause is checked.


\subsection{Vagrant}

The Public Database is more complex than \sapphire and \jsparc. It
requires the Django package \cite{django}, a database and raw data to be
fully tested. These tests can be very time consuming. When developing
code for the Public Database, it is best to test it in en environment
similar to the live server. To accomplish this we use a local virtual
machine that is provisioned by scripts to install the required packages
and setup some configurations. These scripts for provisioning a test
machine can also be used to setup the live server, this ensures that the
test and live server are almost identical.

\todo{Testing publicdb}
